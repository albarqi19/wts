<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة واتساب</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .stats-card {
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            color: white;
        }

        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .stats-card.chats {
            background: linear-gradient(to right, #25D366, #128C7E);
        }

        .stats-card.contacts {
            background: linear-gradient(to right, #34B7F1, #0088cc);
        }

        .stats-card.messages {
            background: linear-gradient(to right, #6f42c1, #6610f2);
        }

        .stats-card.unread {
            background: linear-gradient(to right, #fd7e14, #dc3545);
        }

        .stats-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }

        .stats-number {
            font-size: 2rem;
            font-weight: bold;
        }

        .feature-card {
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            background-color: white;
            text-align: center;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .feature-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .recent-chats {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .recent-chat-item {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .recent-chat-item:hover {
            background-color: #f8f9fa;
        }

        .recent-chat-item:last-child {
            border-bottom: none;
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
        }

        .last-message {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
            color: #6c757d;
        }

        .navbar {
            background-color: var(--primary-color);
        }

        .navbar-brand {
            color: white;
            font-weight: bold;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.85);
        }

        .nav-link:hover {
            color: white;
        }

        .nav-link.active {
            color: white;
            font-weight: bold;
        }

        .qr-section {
            text-align: center;
            padding: 30px;
            border-radius: 10px;
            background-color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .welcome-text {
            max-width: 600px;
            margin: 0 auto 40px auto;
            text-align: center;
        }

        .feature-link {
            text-decoration: none;
            color: inherit;
        }

        .feature-link:hover {
            color: inherit;
        }

        /* أنماط قسم التحديث */
        #update-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            padding: 15px;
            max-width: 350px;
            z-index: 1000;
            display: none;
            transition: all 0.3s ease;
        }

        #update-notification.show {
            display: block;
            animation: slideIn 0.5s forwards;
        }

        @keyframes slideIn {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .progress-small {
            height: 6px;
        }

        .update-icon {
            font-size: 24px;
            color: #0088cc;
        }

        .version-badge {
            font-size: 0.7rem;
            font-weight: normal;
            padding: 3px 6px;
            margin-right: 5px;
            vertical-align: middle;
        }

        .card-update-status {
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <!-- شريط القائمة العلوي -->
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fab fa-whatsapp me-2"></i>
                نظام إدارة واتساب
                <span id="app-version" class="version-badge bg-dark text-white">v1.0.0</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/">الرئيسية</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/chats">المحادثات</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/devices">الأجهزة</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/integration">التكامل</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/ai-response.html">
                            <i class="fas fa-robot me-1"></i>
                            الرد الذكي
                        </a>
                    </li>
                </ul>
                <div class="d-flex">
                    <div id="connection-status" class="badge bg-warning me-2 d-flex align-items-center">جارِ التحميل...</div>
                    <button id="check-updates-btn" class="btn btn-outline-light btn-sm me-2">
                        <i class="fas fa-sync-alt me-1"></i> التحديثات
                    </button>
                    <button id="logout-btn" class="btn btn-outline-light btn-sm d-none">تسجيل الخروج</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div id="qrcode-container" class="qr-section">
            <div class="alert alert-info mb-4">
                <i class="fas fa-info-circle me-2"></i>
                امسح رمز QR باستخدام تطبيق واتساب على هاتفك لبدء استخدام النظام
            </div>
            <div id="qrcode" class="mb-3"></div>
            <p class="text-muted small">
                <i class="fas fa-lock me-1"></i>
                جميع بياناتك آمنة ومشفرة. نحن لا نخزن محتوى الرسائل على خوادمنا.
            </p>
        </div>

        <div id="dashboard" class="d-none">
            <div class="welcome-text">
                <h1 class="mb-3">مرحبًا بك في نظام إدارة واتساب</h1>
                <p class="lead text-muted">
                    يمكنك الآن إدارة محادثات واتساب وجهات الاتصال والرد على الرسائل بكل سهولة من خلال هذه المنصة.
                </p>
            </div>

            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stats-card chats">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5>المحادثات</h5>
                                <div class="stats-number" id="chats-count">0</div>
                            </div>
                            <div class="stats-icon">
                                <i class="far fa-comments"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card contacts">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5>جهات الاتصال</h5>
                                <div class="stats-number" id="contacts-count">0</div>
                            </div>
                            <div class="stats-icon">
                                <i class="far fa-address-book"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card messages">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5>الرسائل اليوم</h5>
                                <div class="stats-number" id="messages-count">0</div>
                            </div>
                            <div class="stats-icon">
                                <i class="far fa-envelope"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card unread">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5>غير مقروءة</h5>
                                <div class="stats-number" id="unread-count">0</div>
                            </div>
                            <div class="stats-icon">
                                <i class="fas fa-bell"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-4">
                    <a href="/chats" class="feature-link">
                        <div class="feature-card">
                            <div class="feature-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                            <h4>المحادثات</h4>
                            <p>عرض وإدارة محادثات واتساب والرد على الرسائل بسهولة</p>
                        </div>
                    </a>
                </div>
                <div class="col-md-4">
                    <a href="/contacts" class="feature-link">
                        <div class="feature-card">
                            <div class="feature-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <h4>إدارة العملاء</h4>
                            <p>تصنيف وإدارة جهات الاتصال وعرض معلومات العملاء</p>
                        </div>
                    </a>
                </div>
                <div class="col-md-4">
                    <a href="/bulk-messaging.html" class="feature-link">
                        <div class="feature-card">
                            <div class="feature-icon">
                                <i class="fas fa-paper-plane"></i>
                            </div>
                            <h4>إرسال رسائل</h4>
                            <p>إرسال رسائل نصية وصور ووسائط إلى عملائك بسهولة</p>
                        </div>
                    </a>
                </div>
            </div>

            <!-- قسم معلومات التحديث -->
            <div class="row">
                <div class="col-12">
                    <div class="card-update-status" id="update-status">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5><i class="fas fa-info-circle text-info me-2"></i> معلومات النظام</h5>
                                <p class="mb-0">الإصدار الحالي: <span id="current-version">1.0.0</span></p>
                                <p class="mb-0 text-muted small" id="last-check-time"></p>
                            </div>
                            <button class="btn btn-primary btn-sm" id="manual-check-btn">
                                <i class="fas fa-sync-alt me-1"></i> تحقق من التحديثات
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- إشعار التحديث -->
    <div id="update-notification">
        <div class="d-flex align-items-center mb-2">
            <div class="update-icon me-3">
                <i class="fas fa-arrow-circle-up"></i>
            </div>
            <div>
                <h5 class="mb-0">تحديث جديد متاح</h5>
                <p class="text-muted mb-0 small" id="new-version-info"></p>
            </div>
        </div>
        <div id="download-progress-container" class="mb-2 d-none">
            <div class="progress progress-small mb-1">
                <div id="download-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
            </div>
            <p class="text-muted mb-0 small text-center" id="download-progress-text">جارِ التنزيل... 0%</p>
        </div>
        <div class="d-flex justify-content-end">
            <button class="btn btn-sm btn-light me-2" id="update-later-btn">لاحقًا</button>
            <button class="btn btn-sm btn-primary" id="update-now-btn">تثبيت الآن</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // تهيئة اتصال Socket.io مع إعدادات محسنة للاتصال
        const socket = io({
            reconnectionAttempts: Infinity, // محاولات إعادة الاتصال غير محدودة
            reconnectionDelay: 1000, // تأخير إعادة الاتصال الأولي (1 ثانية)
            reconnectionDelayMax: 5000, // الحد الأقصى لتأخير إعادة الاتصال (5 ثوان)
            timeout: 20000, // مهلة الاتصال (20 ثانية)
            autoConnect: true, // الاتصال التلقائي عند التهيئة
            forceNew: false, // السماح باستخدام الاتصال الحالي إذا كان موجودًا
            transports: ['websocket', 'polling'] // محاولة WebSocket أولاً ثم الرجوع إلى polling
        });

        // تسجيل معالج لأحداث إعادة الاتصال
        socket.io.on('reconnect_attempt', (attempt) => {
            console.log(`محاولة إعادة الاتصال #${attempt}`);
            connectionStatus.textContent = `جارِ إعادة الاتصال (${attempt})`;
            connectionStatus.className = 'badge bg-warning me-2 d-flex align-items-center';
        });

        socket.io.on('reconnect', () => {
            console.log('تمت إعادة الاتصال بنجاح');
            connectionStatus.textContent = 'تمت إعادة الاتصال';
            connectionStatus.className = 'badge bg-success me-2 d-flex align-items-center';

            // التحقق من حالة الاتصال بعد إعادة الاتصال
            checkForConnectedDevices();
        });

        // عناصر الواجهة
        const qrcodeContainer = document.getElementById('qrcode-container');
        const qrcodeElement = document.getElementById('qrcode');
        const dashboard = document.getElementById('dashboard');
        const connectionStatus = document.getElementById('connection-status');
        const logoutBtn = document.getElementById('logout-btn');
        const chatsCount = document.getElementById('chats-count');
        const contactsCount = document.getElementById('contacts-count');
        const messagesCount = document.getElementById('messages-count');
        const unreadCount = document.getElementById('unread-count');

        // بيانات
        let chats = [];
        let contacts = [];
        let messages = [];
        let isAuthenticated = false;

        // فحص ما إذا كان هناك أي أجهزة متصلة عند تحميل الصفحة
        window.addEventListener('DOMContentLoaded', async function() {
            try {
                // عرض حالة الاتصال الأولية
                connectionStatus.textContent = 'جارِ الاتصال';
                connectionStatus.className = 'badge bg-warning me-2 d-flex align-items-center';

                // استخدام دالة checkForConnectedDevices للتحقق من حالة الاتصال وإعادة الاتصال إذا لزم الأمر
                await checkForConnectedDevices();

                // إضافة مستمع لحدث تحديث الصفحة
                window.addEventListener('beforeunload', function() {
                    // تخزين حالة الاتصال في localStorage لاستعادتها بعد تحديث الصفحة
                    if (isAuthenticated) {
                        localStorage.setItem('wasAuthenticated', 'true');
                    }
                });

                // التحقق مما إذا كان المستخدم مصادقًا عليه قبل تحديث الصفحة
                if (localStorage.getItem('wasAuthenticated') === 'true') {
                    // إزالة العلامة بعد استخدامها
                    localStorage.removeItem('wasAuthenticated');

                    // إذا لم يتم العثور على جهاز متصل بعد، نحاول مرة أخرى بعد فترة قصيرة
                    if (!isAuthenticated) {
                        console.log('محاولة إعادة الاتصال بعد تحديث الصفحة...');

                        // الانتظار لفترة قصيرة ثم محاولة إعادة الاتصال مرة أخرى
                        setTimeout(async () => {
                            await checkForConnectedDevices();
                        }, 2000);
                    }
                }
            } catch (error) {
                console.error('خطأ في التحقق من حالة الاتصال:', error);
            }
        });

        // عند الاتصال
        socket.on('connect', () => {
            connectionStatus.textContent = 'متصل بالخادم';
            connectionStatus.className = 'badge bg-info me-2 d-flex align-items-center';

            // إذا كنا مصادقين بالفعل، جلب البيانات مباشرة
            if (isAuthenticated) {
                fetchData();
            }
        });

        // استقبال رمز QR
        socket.on('qr', (qrImage) => {
            qrcodeElement.innerHTML = `<img src="${qrImage}" alt="رمز QR">`;
            qrcodeContainer.classList.remove('d-none');
            dashboard.classList.add('d-none');
            connectionStatus.textContent = 'في انتظار المسح';
            connectionStatus.className = 'badge bg-warning me-2 d-flex align-items-center';
            logoutBtn.classList.add('d-none');
        });

        // عند المصادقة
        socket.on('authenticated', (info) => {
            isAuthenticated = true;
            connectionStatus.textContent = 'متصل';
            connectionStatus.className = 'badge bg-success me-2 d-flex align-items-center';
            qrcodeContainer.classList.add('d-none');
            dashboard.classList.remove('d-none');
            logoutBtn.classList.remove('d-none');

            // جلب البيانات
            fetchData();
        });

        // استماع إلى تحديثات حالة الأجهزة
        socket.on('device_status_update', (deviceInfo) => {
            if (deviceInfo.status === 'authenticated' || deviceInfo.status === 'connected') {
                isAuthenticated = true;
                connectionStatus.textContent = 'متصل';
                connectionStatus.className = 'badge bg-success me-2 d-flex align-items-center';
                qrcodeContainer.classList.add('d-none');
                dashboard.classList.remove('d-none');
                logoutBtn.classList.remove('d-none');

                // جلب البيانات
                fetchData();
            } else if (deviceInfo.status === 'disconnected' || deviceInfo.status === 'auth_failure') {
                // نتحقق من وجود أجهزة أخرى متصلة قبل تحديث الحالة
                checkForConnectedDevices();
            }
        });

        // عند فشل المصادقة
        socket.on('auth_failure', (message) => {
            // نتحقق من وجود أجهزة أخرى متصلة قبل تحديث الحالة
            checkForConnectedDevices();
        });

        // عند انقطاع الاتصال
        socket.on('disconnected', (reason) => {
            // نتحقق من وجود أجهزة أخرى متصلة قبل تحديث الحالة
            checkForConnectedDevices();
        });

        // التحقق من وجود أجهزة متصلة أخرى
        async function checkForConnectedDevices() {
            try {
                // عرض حالة الاتصال المؤقتة
                connectionStatus.textContent = 'جارِ التحقق من الاتصال';
                connectionStatus.className = 'badge bg-warning me-2 d-flex align-items-center';

                // إضافة تأخير قصير للسماح باستقرار الاتصال
                await new Promise(resolve => setTimeout(resolve, 1000));

                // محاولة الاتصال بالأجهزة المتاحة
                const response = await fetch('/api/devices');
                const result = await response.json();

                if (result.status && result.data && result.data.length > 0) {
                    // البحث عن أي جهاز متصل
                    const connectedDevice = result.data.find(device =>
                        device.status === 'connected' ||
                        device.status === 'authenticated' ||
                        device.currentStatus === 'connected' ||
                        device.currentStatus === 'authenticated'
                    );

                    if (connectedDevice) {
                        console.log('تم العثور على جهاز متصل أثناء التحقق:', connectedDevice.id);

                        // محاولة إعادة الاتصال بالجهاز للتأكد من أنه ما زال متصلاً
                        try {
                            const connectResponse = await fetch(`/api/devices/${connectedDevice.id}/connect`, {
                                method: 'POST'
                            });

                            const connectResult = await connectResponse.json();

                            if (connectResult.status) {
                                console.log(`تم إعادة الاتصال بالجهاز بنجاح: ${connectedDevice.id}`);

                                // تحديث الواجهة لتعكس الحالة المتصلة
                                isAuthenticated = true;
                                connectionStatus.textContent = 'متصل';
                                connectionStatus.className = 'badge bg-success me-2 d-flex align-items-center';
                                qrcodeContainer.classList.add('d-none');
                                dashboard.classList.remove('d-none');
                                logoutBtn.classList.remove('d-none');

                                // جلب البيانات المحدثة
                                fetchData();
                                return;
                            } else {
                                console.log(`فشل في إعادة الاتصال بالجهاز: ${connectResult.message}`);
                            }
                        } catch (connectError) {
                            console.error('خطأ في إعادة الاتصال بالجهاز:', connectError);
                        }
                    }

                    // إذا لم يكن هناك جهاز متصل، نحاول الاتصال بأول جهاز نشط
                    if (!connectedDevice && result.data.length > 0) {
                        const activeDevice = result.data.find(device => device.active !== false);

                        if (activeDevice) {
                            console.log(`محاولة الاتصال بأول جهاز نشط: ${activeDevice.id}`);

                            try {
                                const connectResponse = await fetch(`/api/devices/${activeDevice.id}/connect`, {
                                    method: 'POST'
                                });

                                const connectResult = await connectResponse.json();

                                if (connectResult.status) {
                                    console.log(`تم بدء الاتصال بالجهاز بنجاح: ${activeDevice.id}`);

                                    // عرض حالة جارِ الاتصال
                                    connectionStatus.textContent = 'جارِ الاتصال';
                                    connectionStatus.className = 'badge bg-info me-2 d-flex align-items-center';
                                    qrcodeContainer.classList.remove('d-none');
                                    dashboard.classList.add('d-none');
                                    logoutBtn.classList.add('d-none');

                                    // عرض رمز QR إذا كان متاحًا
                                    if (connectResult.data && connectResult.data.qr) {
                                        qrcodeElement.innerHTML = `<img src="${connectResult.data.qr}" alt="رمز QR">`;
                                    } else {
                                        qrcodeElement.innerHTML = '<div class="spinner-border text-primary" role="status"></div><p class="mt-2">جارِ تحميل رمز QR...</p>';
                                    }

                                    return;
                                }
                            } catch (connectError) {
                                console.error('خطأ في الاتصال بالجهاز:', connectError);
                            }
                        }
                    }
                }

                // لا يوجد أجهزة متصلة
                console.log('لم يتم العثور على أي جهاز متصل أثناء التحقق');
                isAuthenticated = false;
                connectionStatus.textContent = 'غير متصل';
                connectionStatus.className = 'badge bg-danger me-2 d-flex align-items-center';
                qrcodeContainer.classList.remove('d-none');
                dashboard.classList.add('d-none');
                logoutBtn.classList.add('d-none');
            } catch (error) {
                console.error('خطأ في التحقق من حالة الاتصال:', error);
                // في حالة الخطأ، نعرض حالة غير متصل
                isAuthenticated = false;
                connectionStatus.textContent = 'غير متصل';
                connectionStatus.className = 'badge bg-danger me-2 d-flex align-items-center';
                qrcodeContainer.classList.remove('d-none');
                dashboard.classList.add('d-none');
                logoutBtn.classList.add('d-none');
            }
        }

        // استقبال المحادثات
        socket.on('chats', (data) => {
            chats = data;
            updateDashboard();
        });

        // استقبال الرسائل الجديدة
        socket.on('new_message', (message) => {
            // تحديث عدد الرسائل
            messagesCount.textContent = (parseInt(messagesCount.textContent) || 0) + 1;

            // إذا كانت الرسالة غير مقروءة وليست مرسلة مننا
            if (!message.fromMe) {
                unreadCount.textContent = (parseInt(unreadCount.textContent) || 0) + 1;
            }

            // تحديث الدردشة
            fetchData();
        });

        // جلب البيانات
        async function fetchData() {
            try {
                // جلب المحادثات
                const chatsResponse = await fetch('/api/chats');
                const chatsResult = await chatsResponse.json();

                if (chatsResult.status) {
                    chats = chatsResult.data;
                }

                // جلب جهات الاتصال
                const contactsResponse = await fetch('/api/contacts');
                const contactsResult = await contactsResponse.json();

                if (contactsResult.status) {
                    contacts = contactsResult.data;
                }

                // تحديث لوحة المعلومات
                updateDashboard();
            } catch (error) {
                console.error('خطأ في جلب البيانات:', error);
            }
        }

        // تحديث لوحة المعلومات
        function updateDashboard() {
            // تحويل البيانات إلى تنسيق موحد
            let allChats = [];
            let allContacts = [];

            // معالجة بيانات المحادثات
            if (chats) {
                if (Array.isArray(chats)) {
                    // إذا كانت البيانات عبارة عن مصفوفة (من جهاز واحد)
                    allChats = chats;
                } else if (typeof chats === 'object') {
                    // إذا كانت البيانات عبارة عن كائن يحتوي على مصفوفات لكل جهاز
                    for (const deviceId in chats) {
                        if (Array.isArray(chats[deviceId])) {
                            allChats = allChats.concat(chats[deviceId]);
                        }
                    }
                }
            }

            // معالجة بيانات جهات الاتصال
            if (contacts) {
                if (Array.isArray(contacts)) {
                    // إذا كانت البيانات عبارة عن مصفوفة (من جهاز واحد)
                    allContacts = contacts;
                } else if (typeof contacts === 'object') {
                    // إذا كانت البيانات عبارة عن كائن يحتوي على مصفوفات لكل جهاز
                    for (const deviceId in contacts) {
                        if (Array.isArray(contacts[deviceId])) {
                            allContacts = allContacts.concat(contacts[deviceId]);
                        }
                    }
                }
            }

            // تحديث الإحصائيات
            chatsCount.textContent = allChats.length || 0;
            contactsCount.textContent = allContacts.length || 0;

            // حساب عدد الرسائل غير المقروءة
            let totalUnread = 0;
            allChats.forEach(chat => {
                if (chat && typeof chat === 'object') {
                    totalUnread += chat.unreadCount || 0;
                }
            });

            unreadCount.textContent = totalUnread;

            // إذا لم يتم تحديث عدد الرسائل اليوم
            if (messagesCount.textContent === '0') {
                // يمكن تقدير عدد الرسائل اليوم من خلال آخر 5 محادثات
                const todayMessages = estimateTodayMessages(allChats);
                messagesCount.textContent = todayMessages;
            }
        }

        // تقدير عدد الرسائل اليوم
        function estimateTodayMessages(chatsList) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayTimestamp = Math.floor(today.getTime() / 1000);

            // نفترض أن كل محادثة تحتوي على رسالة واحدة على الأقل اليوم
            let count = 0;
            chatsList.forEach(chat => {
                if (chat.lastMessage && chat.lastMessage.timestamp >= todayTimestamp) {
                    count++;
                }
            });

            return count;
        }

        // تنسيق الوقت
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';

            const date = new Date(timestamp * 1000);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            // تنسيق الوقت
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const timeStr = `${hours}:${minutes}`;

            // تحديد ما إذا كان اليوم أو الأمس أو تاريخ كامل
            if (date >= today) {
                return timeStr;
            } else if (date >= yesterday) {
                return 'الأمس';
            } else {
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                return `${day}/${month}/${date.getFullYear()}`;
            }
        }

        // اقتطاع النص إذا كان طويلًا
        function truncateText(text, maxLength) {
            if (!text) return '';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        // تسجيل الخروج
        logoutBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST'
                });

                if (response.ok) {
                    // إعادة تحميل الصفحة بعد تسجيل الخروج
                    window.location.reload();
                } else {
                    alert('حدث خطأ أثناء تسجيل الخروج');
                }
            } catch (error) {
                console.error('خطأ في تسجيل الخروج:', error);
                alert('حدث خطأ أثناء تسجيل الخروج');
            }
        });

        // أكواد التحديث التلقائي للتطبيق
        const updateNotification = document.getElementById('update-notification');
        const newVersionInfo = document.getElementById('new-version-info');
        const updateNowBtn = document.getElementById('update-now-btn');
        const updateLaterBtn = document.getElementById('update-later-btn');
        const checkUpdatesBtn = document.getElementById('check-updates-btn');
        const manualCheckBtn = document.getElementById('manual-check-btn');
        const downloadProgressContainer = document.getElementById('download-progress-container');
        const downloadProgressBar = document.getElementById('download-progress-bar');
        const downloadProgressText = document.getElementById('download-progress-text');
        const appVersionSpan = document.getElementById('app-version');
        const currentVersionSpan = document.getElementById('current-version');
        const lastCheckTimeElem = document.getElementById('last-check-time');

        // في حالة تشغيل التطبيق في بيئة Electron
        let isElectron = false;
        let currentVersion = '1.0.0';

        // تهيئة واجهة التحديثات
        if (window.electron) {
            isElectron = true;
            console.log('تم اكتشاف بيئة Electron');

            // الحصول على معلومات الإصدار الحالي
            window.electron.getVersionInfo().then(info => {
                currentVersion = info.version;
                appVersionSpan.textContent = `v${currentVersion}`;
                currentVersionSpan.textContent = currentVersion;
                console.log(`الإصدار الحالي: ${currentVersion}`);
            }).catch(err => {
                console.error('خطأ في الحصول على معلومات الإصدار:', err);
            });

            // استماع لوجود تحديث متاح
            window.electron.onUpdateAvailable(info => {
                console.log('تحديث متاح:', info);
                newVersionInfo.textContent = `الإصدار الجديد: ${info.version} - تاريخ الإصدار: ${formatDate(info.releaseDate)}`;
                
                // عرض إشعار التحديث
                updateNotification.classList.add('show');
                downloadProgressContainer.classList.add('d-none');
                downloadProgressBar.style.width = '0%';
            });

            // استماع لتقدم تنزيل التحديث
            window.electron.onUpdateProgress(progress => {
                console.log(`تقدم التنزيل: ${progress.percent.toFixed(2)}%`);
                downloadProgressContainer.classList.remove('d-none');
                downloadProgressBar.style.width = `${progress.percent}%`;
                downloadProgressText.textContent = `جارِ التنزيل... ${progress.percent.toFixed(2)}% - ${Math.round(progress.bytesPerSecond / 1024)} كيلوبايت/ثانية`;
            });

            // استماع لاكتمال تنزيل التحديث
            window.electron.onUpdateDownloaded(info => {
                console.log('تم تنزيل التحديث بنجاح');
                downloadProgressText.textContent = 'تم تنزيل التحديث بنجاح! جاهز للتثبيت.';
                downloadProgressBar.classList.remove('progress-bar-animated');
                downloadProgressBar.classList.remove('progress-bar-striped');
                downloadProgressBar.classList.add('bg-success');
                downloadProgressBar.style.width = '100%';
            });

            // استماع لبدء عملية التحقق من التحديثات
            window.electron.onCheckingForUpdate(() => {
                console.log('جارِ التحقق من التحديثات...');
                // تحديث وقت آخر فحص
                updateLastCheckTime();
            });

            // زر التحقق من التحديثات
            checkUpdatesBtn.addEventListener('click', () => {
                window.electron.checkForUpdates();
            });

            // زر التحقق اليدوي من التحديثات (في لوحة المعلومات)
            manualCheckBtn.addEventListener('click', () => {
                window.electron.checkForUpdates();
                // عرض رسالة تأكيد
                manualCheckBtn.disabled = true;
                manualCheckBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> جارِ التحقق...';
                setTimeout(() => {
                    manualCheckBtn.disabled = false;
                    manualCheckBtn.innerHTML = '<i class="fas fa-sync-alt me-1"></i> تحقق من التحديثات';
                    updateLastCheckTime();
                }, 3000);
            });

            // زر تثبيت التحديث الآن
            updateNowBtn.addEventListener('click', () => {
                window.electron.installUpdate();
            });

            // زر تثبيت التحديث لاحقًا
            updateLaterBtn.addEventListener('click', () => {
                updateNotification.classList.remove('show');
            });
        } else {
            // إخفاء عناصر واجهة التحديث في حالة تشغيل التطبيق في المتصفح
            checkUpdatesBtn.classList.add('d-none');
            document.getElementById('update-status').classList.add('d-none');
            console.log('التطبيق يعمل في المتصفح، تم تعطيل ميزة التحديث التلقائي');
        }

        // تنسيق التاريخ بالعربية
        function formatDate(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            
            try {
                return date.toLocaleDateString('ar-SA', options);
            } catch (e) {
                // في حالة عدم دعم التنسيق العربي
                return date.toLocaleDateString('en-US', options);
            }
        }

        // تحديث وقت آخر فحص للتحديثات
        function updateLastCheckTime() {
            const now = new Date();
            const formattedTime = `آخر تحقق: ${now.toLocaleTimeString('ar-SA')} - ${now.toLocaleDateString('ar-SA')}`;
            lastCheckTimeElem.textContent = formattedTime;
            
            // حفظ وقت آخر فحص في localStorage
            localStorage.setItem('lastUpdateCheck', now.toISOString());
        }

        // استرجاع وقت آخر فحص عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            const lastCheck = localStorage.getItem('lastUpdateCheck');
            if (lastCheck) {
                const lastCheckDate = new Date(lastCheck);
                const formattedTime = `آخر تحقق: ${lastCheckDate.toLocaleTimeString('ar-SA')} - ${lastCheckDate.toLocaleDateString('ar-SA')}`;
                lastCheckTimeElem.textContent = formattedTime;
            }
        });
    </script>
</body>
</html>